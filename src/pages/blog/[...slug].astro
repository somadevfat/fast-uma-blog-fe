---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ViewCounter from "../../features/interactions/components/ViewCounter";
import LikeButton from "../../features/interactions/components/LikeButton";
import CommentSection from "../../features/interactions/components/CommentSection";
import { API_BASE_URL } from "../../lib/api";
import { marked } from "marked";

// SSR mode
export const prerender = false;

const { slug } = Astro.params;

let post: any = null;
let isDbPost = false;
let Content: any = null;

// 1. Try DB
try {
  const response = await fetch(`${API_BASE_URL}/posts/${slug}`);
  const result = await response.json();
  if (result.success) {
    const data = result.data;
    post = {
      slug: data.slug,
      data: {
        title: data.title,
        description: "",
        pubDate: new Date(data.createdAt),
        heroImage: "",
      },
      content: data.content,
    };
    isDbPost = true;
  }
} catch (e) {
  console.error("DB Fetch error", e);
}

// 2. Try File
if (!isDbPost) {
  const entry = await getEntry("blog", slug as any);
  if (entry) {
    const rendered = await entry.render();
    Content = rendered.Content;
    post = entry;
  }
}

if (!post) {
  return Astro.redirect("/404");
}

const htmlContent = isDbPost ? await marked.parse(post.content) : "";
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <div class="mb-8 border-b border-wiki-border pb-4">
    <div class="flex items-center gap-4 text-xs text-gray-500 mb-2">
      <time datetime={post.data.pubDate.toISOString()}>
        投稿日: {post.data.pubDate.toLocaleDateString("ja-JP")}
      </time>
      <span>|</span>
      <ViewCounter client:load slug={post.slug} />
    </div>
    <h1>{post.data.title}</h1>
  </div>

  {
    post.data.heroImage && (
      <div class="mb-8 overflow-hidden border border-wiki-border p-1 bg-white">
        <img src={post.data.heroImage} alt="" class="w-full h-auto" />
      </div>
    )
  }

  <div class="wiki-content mb-12">
    {isDbPost ? <Fragment set:html={htmlContent} /> : <Content />}
  </div>

  <div class="sidebar-box border-dashed">
    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
      <div class="text-sm">
        <strong>この記事への評価:</strong>
        <p class="text-xs text-gray-500">
          役に立ったら「いいね」をお願いします。
        </p>
      </div>
      <LikeButton client:load slug={post.slug} />
    </div>
  </div>

  <div class="mt-12 border-t border-wiki-border pt-8">
    <h2 class="!mt-0 !bg-transparent !border-l-0 !pl-0 text-xl font-bold mb-6">
      コメント一覧
    </h2>
    <CommentSection client:visible slug={post.slug} />
  </div>
</BaseLayout>

<style is:global>
  /* Wiki-like prose overrides */
  .wiki-content {
    font-size: 1rem;
    line-height: 1.8;
  }
  .wiki-content p {
    margin-bottom: 1.5em;
  }
  .wiki-content h2 {
    margin-top: 2em;
    margin-bottom: 1em;
  }
  .wiki-content img {
    border: 1px solid #ccc;
    padding: 4px;
    background: #fff;
    max-width: 100%;
    height: auto;
  }
  .wiki-content pre {
    background: #f4f4f4;
    border: 1px solid #ddd;
    border-left: 3px solid #4a90e2;
    padding: 1em;
    overflow-x: auto;
    font-size: 0.9em;
    margin-bottom: 1.5em;
  }
  .wiki-content code:not(pre code) {
    background: #f0f0f0;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.9em;
  }
  .wiki-content ul,
  .wiki-content ol {
    margin-bottom: 1.5em;
    padding-left: 1.5em;
  }
  .wiki-content li {
    margin-bottom: 0.5em;
  }
</style>
